#!/bin/sh

# AREDN Phonebook - Show Phonebook Webhook
# Returns current phonebook contents as JSON

# Set response headers
echo "Content-Type: application/json"
echo "Access-Control-Allow-Origin: *"
echo ""

# Phonebook XML file path
XML_FILE="/www/arednstack/phonebook_generic_direct.xml"

# Check if phonebook file exists
if [ ! -f "$XML_FILE" ]; then
    echo '{"status":"error","message":"Phonebook not available","timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}'
    exit 0
fi

# Get file modification time
LAST_UPDATED=$(stat -c %Y "$XML_FILE" 2>/dev/null)
if [ -n "$LAST_UPDATED" ]; then
    LAST_UPDATED_ISO=$(date -u -d @$LAST_UPDATED +"%Y-%m-%dT%H:%M:%SZ")
else
    LAST_UPDATED_ISO="unknown"
fi

# Count entries in phonebook
ENTRY_COUNT=$(grep -c "<YealinkIPPhoneDirectory>" "$XML_FILE" 2>/dev/null || echo "0")

# Extract entries from XML and convert to JSON format
echo '{"status":"success","last_updated":"'$LAST_UPDATED_ISO'","entry_count":'$ENTRY_COUNT',"entries":['

FIRST_ENTRY=true
# Parse XML entries and convert to JSON
grep -A2 -B1 "<Name>" "$XML_FILE" 2>/dev/null | while IFS= read -r line; do
    if echo "$line" | grep -q "<Name>"; then
        NAME=$(echo "$line" | sed 's/<Name>\(.*\)<\/Name>/\1/' | sed 's/&amp;/\&/g; s/&lt;/</g; s/&gt;/>/g; s/&quot;/"/g; s/&#39;/'"'"'/g')
        # Read next line for telephone
        read -r tel_line
        if echo "$tel_line" | grep -q "<Telephone>"; then
            TELEPHONE=$(echo "$tel_line" | sed 's/<Telephone>\(.*\)<\/Telephone>/\1/')

            if [ "$FIRST_ENTRY" = "true" ]; then
                FIRST_ENTRY=false
            else
                echo ","
            fi
            echo -n '{"name":"'"$NAME"'","telephone":"'"$TELEPHONE"'"}'
        fi
    fi
done

echo '],"timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}'